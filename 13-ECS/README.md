# Topic 13: Elastic Container Service (ECS)

<!-- Generated by: https://ecotrust-canada.github.io/markdown-toc/ -->

- [Topic 13: Elastic Container Service (ECS)](#topic-13-elastic-container-service-ecs)
  - [Guidance](#guidance)
  - [Lesson 13.1: Elastic Container Registry - ECR](#lesson-131-elastic-container-registry---ecr)
    - [Principle 13.1](#principle-131)
    - [Practice 13.1](#practice-131)
      - [Lab 13.1.1 Create a Repository](#lab-1311-create-a-repository)
      - [Lab 13.1.2 Create a life-cycle policy that expires images after a month](#lab-1312-create-a-life-cycle-policy-that-expires-images-after-a-month)
      - [Lab 13.1.3 Create a life-cycle policy that keeps only one untagged image](#lab-1313-create-a-life-cycle-policy-that-keeps-only-one-untagged-image)
      - [Lab 13.1.4 Use `ecr get-login` to authorize your Docker CLI](#lab-1314-use-ecr-get-login-to-authorize-your-docker-cli)
      - [Lab 13.1.5 Use `ecr get-authorization-token` to authorize your Docker CLI](#lab-1315-use-ecr-get-authorization-token-to-authorize-your-docker-cli)
      - [Lab 13.1.6 Push the latest image of NGINX from DockerHub to your repository](#lab-1316-push-the-latest-image-of-nginx-from-dockerhub-to-your-repository)
    - [Retrospective 13.1](#retrospective-131)
      - [Question: Image Encryption](#question-image-encryption)
      - [Question: Image Mirroring](#question-image-mirroring)
      - [Question: Repository Policies](#question-repository-policies)
      - [Question: Repository Authentication](#question-repository-authentication)
  - [Lesson 13.2: Elastic Container Service - Classic ECS](#lesson-132-elastic-container-service---classic-ecs)
    - [Principle 13.2](#principle-132)
    - [Practice 13.2](#practice-132)
      - [Lab 13.2.1 Create an ECS Cluster](#lab-1321-create-an-ecs-cluster)
      - [Lab 13.2.2 Add EC2 capacity to your Cluster](#lab-1322-add-ec2-capacity-to-your-cluster)
      - [Lab 13.2.3 Create a Task Definition with your NGINX container](#lab-1323-create-a-task-definition-with-your-nginx-container)
      - [Lab 13.2.4 Create a Service that runs your Task Definition](#lab-1324-create-a-service-that-runs-your-task-definition)
      - [Lab 13.2.5 Deploy your stack and verify your configuration](#lab-1325-deploy-your-stack-and-verify-your-configuration)
    - [Retrospective 13.2](#retrospective-132)
      - [Task: Enable CloudWatch logging](#task-enable-cloudwatch-logging)
      - [Task: Cleanup your ECS service](#task-cleanup-your-ecs-service)
      - [Question: Clusters with non-default names](#question-clusters-with-non-default-names)
      - [Question: ECS with custom AMIs](#question-ecs-with-custom-amis)
  - [Lesson 13.3: Elastic Container Service - Fargate ECS](#lesson-133-elastic-container-service---fargate-ecs)
    - [Principle 13.3](#principle-133)
    - [Practice 13.3](#practice-133)
      - [Lab 13.3.1 Create an ECS Cluster](#lab-1331-create-an-ecs-cluster)
      - [Lab 13.3.2 Create a Task Definition with two of your NGINX containers](#lab-1332-create-a-task-definition-with-two-of-your-nginx-containers)
      - [Lab 13.3.3 Create a Service that runs your Task Definition](#lab-1333-create-a-service-that-runs-your-task-definition)
      - [Lab 13.3.4 Deploy your stack and verify your configuration](#lab-1334-deploy-your-stack-and-verify-your-configuration)
    - [Retrospective 13.3](#retrospective-133)
      - [Question: EC2 capacity](#question-ec2-capacity)
      - [Question: Fargate volume/bind mounts](#question-fargate-volumebind-mounts)
      - [Question: Fargate Networking](#question-fargate-networking)
      - [Question: Fargate vs. Classic](#question-fargate-vs-classic)
      - [Question: Scaling vertically and horizontally](#question-scaling-vertically-and-horizontally)
      - [Task: Cleanup](#task-cleanup)
  - [Further Reading](#further-reading)

## Guidance

- Explore ECS developer guides: [on AWS](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html)
- If at any point you are confused with the terminology of ECS, keep the
  following diagram in mind:

  ```text
  +-----------------------------------------------------------+
  | +----------------------+         +----------------------+ |
  | | +--------------------------------------------------+  | |
  | | | +------+ +------+  |         | +------+ +------+ |  | |
  | | | |      | |      |  |         | |      | |      | |  | |
  | | | | Task | | Task |  |         | | Task | | Task | |  | |
  | | | |      | |      |  |         | |      | |      | |  | |
  | | | +------+ +------+  |         | +------+ +------+ |  | |
  | | |                    | Service |                   |  | |
  | | +--------------------------------------------------+  | |
  | | Container            |         | Container            | |
  | | Instance             |         | Instance             | |
  | +----------------------+         +----------------------+ |
  |                                                           |
  |                        ECS Cluster                        |
  +-----------------------------------------------------------+
  ```

- For lessons 2 and 3, a [starter](starter.yml) CloudFormation stack is
  provided for you. This stack lacks all resources under `AWS::ECS::*`
  namespace and relevant resources required in adding _EC2 capacity_ to an
  ECS cluster. You are more than welcome to write everything from scratch
  or use CDK and/or similar tools. This template is just provided for your
  convenience.

## Lesson 13.1: Elastic Container Registry - ECR

### Principle 13.1

*ECR is the preferred way to store, update, and deploy Docker containers on AWS.*

### Practice 13.1

This section walks you through setting up a basic ECR repository which houses the
latest NGINX container image. The repository and its images will be used in the
future parts of this course.

#### Lab 13.1.1 Create a Repository

Create a new ECR docker repository.

- Use the [AWS::ECR::Repository](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecr-repository.html)
  resource type.
- You will use this repository throughout this course, so export it from your
  CloudFormation stack with an [output](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html).

#### Lab 13.1.2 Create a life-cycle policy that expires images after a month

Modify your repository to include this life-cycle policy.

#### Lab 13.1.3 Create a life-cycle policy that keeps only one untagged image

Modify your repository to include this life-cycle policy.

#### Lab 13.1.4 Use `ecr get-login` to authorize your Docker CLI

Docker CLI needs to have access to your ECR repository before you can push to and
pull images from it. Take a quick glance at [ECR CLI commands](https://docs.aws.amazon.com/cli/latest/reference/ecr/index.html#cli-aws-ecr):

- Use `docker logout` to clear your previous sessions.
- Try `docker pull`ing the image you exported earlier from your stack. It
  should fail.
- Use `ecr get-login` to login to your ECR repository.
- Try `docker pull`ing the image you exported earlier from your stack. It
  should succeed, can you explain what happened?

#### Lab 13.1.5 Use `ecr get-authorization-token` to authorize your Docker CLI

Take a quick look at the documentation for [this lab](https://docs.aws.amazon.com/cli/latest/reference/ecr/get-authorization-token.html):

- Use `docker logout` to clear your previous sessions.
- Try `docker pull`ing the image you exported earlier from your stack. It
  should fail.
- Use `ecr get-authorization-token` to obtain a base64 encoded authorization
  token for Docker CLI.
- Base64 decode the token and `docker login` with it. Use `AWS` as username
  for Docker CLI.
- Try `docker pull`ing the image you exported earlier from your stack. It
  should succeed, can you explain what happened?

#### Lab 13.1.6 Push the latest image of NGINX from DockerHub to your repository

Pull the latest [NGINX](https://hub.docker.com/_/nginx) image and push it to
your ECR repository

- Verify you pushed successfully by `docker run`ing off of your ECR repo.
- One liner for running a container and auto-removing it upon exit:
  `docker run --rm -it <image>`.

### Retrospective 13.1

#### Question: Image Encryption

_We did not talk about encryption of images in this lab. How do you make sure
images are encrypted at rest and while in-transit when using ECR?_

#### Question: Image Mirroring

_When pushing public images from Docker Hub to ECR, images can get out of date
compared to their version on Docker Hub. Think about AWS native solutions to
mirror a public Docker Hub image on ECR._

#### Question: Repository Policies

_In order to follow *the least privileges* principal, it is a common ask to set
up repository policies for an ECR repository. What are some conditions you can
impose on accessing a repository?_

#### Question: Repository Authentication

_In this lesson, you were presented with two authentication methods for your
Docker CLI. Explain the differences and why would you choose one over the other._

## Lesson 13.2: Elastic Container Service - Classic ECS

### Principle 13.2

_ECS (Classic ECS or EC2 backed ECS) is a way to orchestrate, provision and run
containers on AWS._

### Practice 13.2

This section walks you through creating an ECS deployment which serves a basic
_nginx_ web server container. This is a long and complicated sequence of labs.
At the end of the lab, you should have a basic grasp on how to run containers on
AWS through ECS.

#### Lab 13.2.1 Create an ECS Cluster

Create an ECS cluster for your service:

- Use the provided [starter](starter.yml) CloudFormation template (`starter.yml`).
- Use the [AWS::ECS::Cluster](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-cluster.html)
  resource type.
- Tag your cluster with your Stelligent labs account name.

#### Lab 13.2.2 Add EC2 capacity to your Cluster

Modify your cluster to have _EC2 capacity_:

- Use the [AWS::AutoScaling::LaunchConfiguration](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html)
  resource type.
- Set your Container Instances to be of type _t2.micro_.
- Setup Container Instance security groups to allow outgoing port 80 traffic.
- Use Amazon Linux 2 for your AMI.

#### Lab 13.2.3 Create a Task Definition with your NGINX container

Create a task definition that includes one instance of your NGINX container from
the previous lesson:

- Expose port 80 in the task definition
- Set _CPU_ to 256 and _Memory_ to 512

#### Lab 13.2.4 Create a Service that runs your Task Definition

Create a Service that runs your task:

- Use the [AWS::ECS::Service](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html)
  resource type.
- Set _DesiredCount_ to 1

#### Lab 13.2.5 Deploy your stack and verify your configuration

Deploy your finished CloudFormation stack and verify it works by exporting stack's
public load balancer DNS address through a CloudFormation Output.

### Retrospective 13.2

#### Task: Enable CloudWatch logging

Now that your container is running, you need to have access to its logs. Go back
and configure your containers to log to CloudWatch. What steps do you need to take
to enable this feature?

#### Task: Cleanup your ECS service

Remove your entire ECS service, its associated ELB, auto-scaler, task definition,
service and cluster. Do not remove the ECR repository yet! You will need it in the
next lesson.

#### Question: Clusters with non-default names

_If you don't name your Cluster, it will be named `default` and no further
configuration is needed in your EC2 instances. By referring to the documentation
for [ECS agents](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-agent-install.html),
explain the steps required to associate EC2 Container Instances with a non-default
cluster._

#### Question: ECS with custom AMIs

_You can run containers on your own AMIs. Can you explain how is this possible?_

## Lesson 13.3: Elastic Container Service - Fargate ECS

### Principle 13.3

_Fargate is a managed and serverless abstraction over ECS. Fargate is the preferred
way to run containers on AWS_

### Practice 13.3

This section introduces you to ECS Fargate, a serverless approach to running
containers. You will deploy the same service as the previous lesson on Fargate.

#### Lab 13.3.1 Create an ECS Cluster

Create an ECS cluster for your service:

- Use the provided [starter](starter.yml) CloudFormation template (`starter.yml`).
- Use the [AWS::ECS::Cluster](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-cluster.html)
  resource type.
- Tag your cluster with your Stelligent labs account name.

#### Lab 13.3.2 Create a Task Definition with two of your NGINX containers

Create a task definition that includes an instance of your NGINX container from
the previous lessons:

- Expose port 80 in the task definition
- Set _CPU_ to 256 vCPU and _Memory_ to 512
- Set _RequiresCompatibilities_ to _FARGATE_
- Set networking mode to _awsvpc_

#### Lab 13.3.3 Create a Service that runs your Task Definition

Create a Service that runs your task.

- Use the [AWS::ECS::Service](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html)
  resource type.
- Set _DesiredCount_ to 1

#### Lab 13.3.4 Deploy your stack and verify your configuration

Deploy your finished CloudFormation stack and verify it works by exporting stack's
public load balancer DNS address through a CloudFormation Output.

### Retrospective 13.3

#### Question: EC2 capacity

_You did not need to specify an EC2 capacity in this lab, why?_

#### Question: Fargate volume/bind mounts

_Fargate does not support volume and bind mounts. Why?_

#### Question: Fargate Networking

_[Container linking](https://docs.docker.com/network/links/) is a deprecated feature
of Docker and it is still widely used! This is currently supported on ECS, but not
on Fargate. Can you explain how a similar networking setup can be achieved on Fargate
without container linking?_

#### Question: Fargate vs. Classic

_Under what circumstances could you _not_ use Fargate and why? Would ECS be capable
of handling these situations?_

#### Question: Scaling vertically and horizontally

_In terms of ECS application scaling, horizontal scaling means having more machines
and scaling vertically means having more instances of the same application on the
same machine. Can you explain which one of these are possible on Fargate and which
ones are possible on ECS and why? Be precise in explaining the differences._

#### Task: Cleanup

Cleanup after yourself! Remove all the resources you created during completion of
the above labs (including the ECR repository).

## Further Reading

- Make sure you understand how [Fargate networking](https://aws.amazon.com/blogs/compute/task-networking-in-aws-fargate/)
  works. Fargate is a sandbox, you need to know its ins and outs as it does not
  provide granular configuration options.
- You can share your ECR images cross accounts. See an example
  [repository policy here](https://docs.aws.amazon.com/AmazonECR/latest/userguide/RepositoryPolicyExamples.html#IAM_allow_other_accounts).
- Fargate has its own official CLI that abstracts a lot of CloudFormation details.
  [Check it out here](https://github.com/awslabs/fargatecli).
